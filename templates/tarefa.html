{% extends "base.html" %}
{% load static %}

{% block title %}AGROS - Produﾃｧﾃ｣o de Leite{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<div class="work-wrapper">
    <div class="glass-overlay"></div>
    
    <div class="work-container">
        
        {# HEADER PERSONALIZADO AGROS #}
        <div class="header-premium">
            <div class="brand-group">
                <div class="logo-circle"><i class="fa-solid fa-cow"></i></div>
                <div class="brand-text">
                    <h1>AGROS MILK</h1>
                    <p><i class="fa-solid fa- seedling"></i> Produﾃｧﾃ｣o Sustentﾃ｡vel</p>
                </div>
            </div>
            <div class="badge-status {% if is_estagiario %}is-free{% endif %}">
                {% if is_estagiario %}ESTAGIﾃヽIO{% else %}PRODUTOR VIP{% endif %}
            </div>
        </div>

        {# CONTEﾃ咼O PRINCIPAL #}
        <div class="content-body">
            
            {# SEﾃﾃグ 1: SELEﾃﾃグ DE Vﾃ好EOS #}
            <div id="section-select" class="view-section">
                {% if is_sunday %}
                    <div class="sunday-card">
                        <div class="cow-icon-animation">推彫</div>
                        <h3>Dia de Pasto</h3>
                        <p>Aos Domingos, nossas vacas descansam e a produﾃｧﾃ｣o para. Voltamos amanhﾃ｣ ﾃs 09:00!</p>
                        <a href="{% url 'menu' %}" class="btn-back-home">Voltar ao Inﾃｭcio</a>
                    </div>
                {% else %}
                    <div class="task-info-card">
                        <p>Selecione um processo de produﾃｧﾃ｣o para supervisionar hoje.</p>
                        {% if is_estagiario %}
                        <div class="mini-alert">Recompensa: <strong>500 KZ</strong></div>
                        {% endif %}
                    </div>

                    <div class="video-grid">
                        {# CARD Vﾃ好EO 1 #}
                        <div class="video-item" onclick="startVideo('leite_1.mp4', 'Extraﾃｧﾃ｣o Automatizada')">
                            <div class="video-thumb">
                                <i class="fa-solid fa-play"></i>
                                <span class="duration">0:15</span>
                            </div>
                            <div class="video-meta">
                                <h3>Extraﾃｧﾃ｣o Automatizada</h3>
                                <span>Vﾃｭdeo Educativo 01</span>
                            </div>
                        </div>

                        {# CARD Vﾃ好EO 2 #}
                        <div class="video-item" onclick="startVideo('leite_2.mp4', 'Controle de Qualidade')">
                            <div class="video-thumb">
                                <i class="fa-solid fa-play"></i>
                                <span class="duration">0:20</span>
                            </div>
                            <div class="video-meta">
                                <h3>Controle de Qualidade</h3>
                                <span>Vﾃｭdeo Educativo 02</span>
                            </div>
                        </div>

                        {# CARD Vﾃ好EO 3 #}
                        <div class="video-item" onclick="startVideo('leite_3.mp4', 'Processamento UHT')">
                            <div class="video-thumb">
                                <i class="fa-solid fa-play"></i>
                                <span class="duration">0:18</span>
                            </div>
                            <div class="video-meta">
                                <h3>Processamento UHT</h3>
                                <span>Vﾃｭdeo Educativo 03</span>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            {# SEﾃﾃグ 2: PLAYER DE Vﾃ好EO #}
            <div id="section-player" class="view-section" style="display: none;">
                <div class="player-box-glass">
                    <h2 id="video-title">Supervisionando...</h2>
                    <div class="video-container-internal">
                        <video id="main-video" width="100%" preload="auto">
                            <source src="" type="video/mp4">
                            Seu navegador nﾃ｣o suporta vﾃｭdeos.
                        </video>
                        <div id="video-overlay-lock">Assista atﾃｩ o final para ganhar</div>
                    </div>
                    
                    <div id="progress-container">
                        <div id="progress-bar"></div>
                    </div>

                    <div id="load-box" style="display: none;">
                        <div class="custom-loader"></div>
                        <p>Validando supervisﾃ｣o...</p>
                    </div>

                    <button id="final-submit" class="btn-confirm-eval" disabled>CONCLUIR TAREFA</button>
                </div>
            </div>

            {# SEﾃﾃグ 3: FINALIZADO #}
            <div id="section-done" class="view-section" style="display: none;">
                <div class="success-screen">
                    <div class="success-icon-check">
                        <i class="fa-solid fa-circle-check"></i>
                    </div>
                    <h2>Produﾃｧﾃ｣o Concluﾃｭda!</h2>
                    <p>Vocﾃｪ supervisionou a produﾃｧﾃ｣o com sucesso. Seu bﾃｴnus jﾃ｡ foi creditado no saldo disponﾃｭvel.</p>
                    <a href="{% url 'menu' %}" class="btn-back">Voltar ao Painel</a>
                </div>
            </div>

        </div>

        {# PUBLICIDADE #}
        <div class="ads-card-premium">
            <div class="ad-label">AGROS PUBLICIDADE</div>
            <div class="ad-content-box">
                <i class="fa-solid fa-truck-fast"></i>
                <p>Logﾃｭstica Agros: Entregando leite fresco em toda Angola.</p>
            </div>
        </div>

    </div>
</div>

<style>
    :root {
        --primary: #2d5a27; /* Verde Agro */
        --accent: #ffcc00; /* Amarelo */
        --glass: rgba(255, 255, 255, 0.12);
        --glass-border: rgba(255, 255, 255, 0.2);
    }

    .work-wrapper { 
        min-height: 100vh; 
        background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('{% static "images/farm-bg.jpg" %}') center/cover;
        display: flex; justify-content: center; padding: 20px 0; font-family: 'Poppins', sans-serif;
    }
    .work-container { width: 95%; max-width: 450px; position: relative; z-index: 5; }

    /* HEADER */
    .header-premium { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); padding: 15px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
    .logo-circle { width: 45px; height: 45px; background: white; color: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .brand-text h1 { color: white; font-size: 18px; margin: 0; font-weight: 700; }
    .brand-text p { color: var(--accent); font-size: 10px; margin: 0; }
    .badge-status { background: #fff; color: var(--primary); padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: 800; }
    .badge-status.is-free { background: var(--accent); }

    /* VIDEO GRID */
    .video-grid { display: flex; flex-direction: column; gap: 15px; }
    .video-item { background: white; border-radius: 18px; display: flex; padding: 10px; gap: 15px; cursor: pointer; transition: 0.3s; }
    .video-item:active { transform: scale(0.97); }
    .video-thumb { width: 100px; height: 70px; background: #222; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; color: white; }
    .duration { position: absolute; bottom: 5px; right: 5px; font-size: 9px; background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 4px; }
    .video-meta h3 { margin: 0; font-size: 15px; color: #333; }
    .video-meta span { font-size: 12px; color: #777; }

    /* PLAYER */
    .player-box-glass { background: var(--glass); backdrop-filter: blur(15px); padding: 20px; border-radius: 25px; border: 1px solid var(--glass-border); color: white; text-align: center; }
    .video-container-internal { position: relative; border-radius: 15px; overflow: hidden; margin: 15px 0; background: #000; }
    #video-overlay-lock { position: absolute; top: 10px; right: 10px; font-size: 10px; background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 5px; }
    #progress-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
    #progress-bar { width: 0%; height: 100%; background: var(--accent); transition: 0.1s; }

    /* SUNDAY CARD */
    .sunday-card { background: white; padding: 40px 20px; border-radius: 25px; text-align: center; }
    .cow-icon-animation { font-size: 50px; margin-bottom: 10px; }
    .btn-back-home { display: block; margin-top: 20px; background: var(--primary); color: white; padding: 12px; border-radius: 12px; text-decoration: none; font-weight: 600; }

    /* SUCCESS SCREEN */
    .success-icon-check { font-size: 70px; color: #4CAF50; margin-bottom: 15px; }
    .btn-back { display: inline-block; color: white; background: var(--primary); padding: 12px 30px; border-radius: 30px; text-decoration: none; margin-top: 20px; }

    /* ADS */
    .ads-card-premium { margin-top: 25px; background: var(--glass); border-radius: 15px; padding: 15px; border: 1px solid var(--glass-border); color: white; }
    .ad-label { font-size: 8px; opacity: 0.6; margin-bottom: 8px; }
    .ad-content-box { display: flex; align-items: center; gap: 15px; }
    .ad-content-box i { font-size: 25px; color: var(--accent); }
    .ad-content-box p { font-size: 11px; margin: 0; }

    .btn-confirm-eval { width: 100%; padding: 15px; border-radius: 15px; border: none; background: #555; color: white; font-weight: 700; transition: 0.3s; }
    .btn-confirm-eval.ready { background: var(--accent); color: #000; cursor: pointer; box-shadow: 0 5px 15px rgba(255,204,0,0.4); }
    
    .custom-loader { width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const sectionSelect = document.getElementById('section-select');
    const sectionPlayer = document.getElementById('section-player');
    const sectionDone = document.getElementById('section-done');
    const videoElem = document.getElementById('main-video');
    const progressBar = document.getElementById('progress-bar');
    const finalSubmit = document.getElementById('final-submit');
    const videoTitle = document.getElementById('video-title');

    // Se jﾃ｡ completou hoje, mostra tela final
    if ({{ tasks_completed_today|default:0 }} >= 1) {
        showSection('done');
    }

    window.startVideo = function(videoFile, title) {
        videoTitle.innerText = title;
        videoElem.src = "{% static 'videos/' %}" + videoFile;
        showSection('player');
        videoElem.play();
    };

    videoElem.ontimeupdate = function() {
        let percentage = (videoElem.currentTime / videoElem.duration) * 100;
        progressBar.style.width = percentage + "%";
        
        if (percentage >= 99) {
            finalSubmit.disabled = false;
            finalSubmit.classList.add('ready');
            finalSubmit.innerText = "COLETAR RECOMPENSA";
        }
    };

    finalSubmit.addEventListener('click', function() {
        this.style.display = 'none';
        document.getElementById('load-box').style.display = 'block';

        fetch("{% url 'process_task' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            setTimeout(() => {
                if (data.success) {
                    showSection('done');
                } else {
                    alert(data.message);
                    location.reload();
                }
            }, 1500);
        });
    });

    function showSection(type) {
        sectionSelect.style.display = 'none';
        sectionPlayer.style.display = 'none';
        sectionDone.style.display = 'none';
        if (type === 'player') sectionPlayer.style.display = 'block';
        else if (type === 'done') sectionDone.style.display = 'block';
        else sectionSelect.style.display = 'block';
    }
});
</script>
{% endblock %}
