{% extends "base.html" %}
{% load static %}

{% block title %}Dep√≥sito{% endblock %}

{% block content %}
<div class="deposit-container">
    <div class="jackpay-header">
        <div class="logo-box">
            <span class="logo-icon">üí†</span> JackPay
        </div>
    </div>

    <div class="stepper">
        <div class="step-item" id="step-dot-1">
            <div class="circle active">1</div>
            <span>Escolher</span>
        </div>
        <div class="line"></div>
        <div class="step-item" id="step-dot-2">
            <div class="circle">2</div>
            <span>Pagar</span>
        </div>
        <div class="line"></div>
        <div class="step-item" id="step-dot-3">
            <div class="circle">3</div>
            <span>Comprovativo</span>
        </div>
    </div>

    {% if deposit_success %}
        <div class="success-screen">
            <div class="success-icon">‚úì</div>
            <h2>Dep√≥sito Enviado com Sucesso!</h2>
            <p>O seu dep√≥sito est√° a ser processado e ser√° confirmado em 5 a 30 minutos.</p>
            <a href="{% url 'menu' %}" class="btn-main">Voltar ao Menu</a>
        </div>
    {% else %}
        <form id="deposit-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="{{ form.amount.name }}" id="id_amount" value="">
            <input type="hidden" name="selected_bank" id="id_selected_bank" value="">

            <div id="step-1" class="step-content">
                <div class="balance-card">
                    <p>Saldo</p>
                    <h3>Kz 0.00</h3>
                </div>

                <div class="amount-section">
                    <label>Valor do Recarregamento</label>
                    <div class="input-wrapper">
                        <span>Kz</span>
                        <input type="number" id="manual-amount" placeholder="Valor do Recarregamento">
                    </div>

                    <p class="label-small">Valores R√°pidos</p>
                    <div class="grid-amounts">
                        {% for deposit_value in level_deposits_list %}
                            <button type="button" class="amount-btn" data-value="{{ deposit_value }}">{{ deposit_value }}</button>
                        {% endfor %}
                    </div>
                </div>

                <div class="info-rules">
                    <h4>Informa√ß√µes Importantes</h4>
                    <ul>
                        <li><span>1</span> N√£o Deposite valores em bancos diferentes.</li>
                        <li><span>2</span> N√£o falsifique os comprovativos, para evitar banir a sua conta.</li>
                        <li><span>3</span> Hor√°rio de dep√≥sito: <strong>08:30 at√© 20:00</strong>.</li>
                        <li><span>4</span> Dias de Dep√≥sito: <strong>Segunda a Domingo</strong>.</li>
                    </ul>
                </div>
                
                <button type="button" class="btn-main" id="to-step-2" disabled>Recarregar Agora</button>
            </div>

            <div id="step-2" class="step-content" style="display: none;">
                <div class="bank-list">
                    {% for bank in platform_bank_details %}
                        <button type="button" class="bank-option-btn" data-bank-id="{{ forloop.counter }}">
                            {{ bank.bank_name }}
                        </button>
                    {% endfor %}
                </div>
                <button type="button" class="btn-main" id="to-step-3" style="margin-top:20px" disabled>Pr√≥xima etapa</button>
            </div>

            <div id="step-3" class="step-content" style="display: none;">
                <div class="bank-details-wrapper">
                    {% for bank in platform_bank_details %}
                        <div id="details-{{ forloop.counter }}" class="bank-info-card" style="display: none;">
                            <div class="info-group">
                                <label>M√©todo de Pagamento</label>
                                <div class="copy-input">
                                    <input type="text" value="{{ bank.bank_name }}" readonly>
                                    <button type="button" class="copy-icon">üìã</button>
                                </div>
                            </div>
                            <div class="info-group">
                                <label>Nome de Usu√°rio</label>
                                <div class="copy-input">
                                    <input type="text" value="{{ bank.account_holder_name }}" readonly>
                                    <button type="button" class="copy-icon">üìã</button>
                                </div>
                            </div>
                            <div class="info-group">
                                <label>N√∫mero da Conta (IBAN)</label>
                                <div class="copy-input">
                                    <input type="text" value="{{ bank.IBAN }}" id="iban-{{ forloop.counter }}" readonly>
                                    <button type="button" class="copy-icon" onclick="copyText('iban-{{ forloop.counter }}')">üìã</button>
                                </div>
                            </div>
                            <div class="info-group">
                                <label>Valor do Pagamento</label>
                                <div class="copy-input">
                                    <input type="text" class="display-final-amount" readonly>
                                    <button type="button" class="copy-icon">üìã</button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-main" id="to-step-4">J√° fiz o pagamento</button>
            </div>

            <div id="step-4" class="step-content" style="display: none;">
                <p class="upload-label">comprovante de pagamento</p>
                <div class="upload-box" onclick="document.getElementById('file-upload').click()">
                    <div class="upload-icon">‚òÅÔ∏è</div>
                    <input type="file" name="{{ form.proof_of_payment.name }}" id="file-upload" hidden accept="image/*">
                    <p id="file-name" style="font-size: 12px; color: #888;"></p>
                </div>
                
                <div class="info-group" style="margin-top: 20px;">
                    <input type="text" name="payer_name" placeholder="Nome do pagador" class="simple-input" required>
                </div>

                <button type="submit" class="btn-main btn-submit" style="background-color: #1abc9c;">Enviar</button>
            </div>
        </form>
    {% endif %}
</div>

<style>
    :root {
        --primary-blue: #4e73df;
        --secondary-teal: #1abc9c;
        --bg-light: #f8f9fc;
        --text-dark: #333;
    }

    body { background-color: #eee; font-family: sans-serif; margin: 0; }

    .deposit-container {
        max-width: 450px;
        margin: 0 auto;
        background: white;
        min-height: 100vh;
        padding: 20px;
    }

    /* Header Estilo JackPay */
    .jackpay-header {
        text-align: center;
        margin-bottom: 30px;
    }
    .logo-box {
        background: linear-gradient(to right, #b8c6ff, #f5f7ff);
        padding: 10px 40px;
        display: inline-block;
        border-radius: 4px;
        font-weight: bold;
        color: #2c3e50;
        font-size: 24px;
    }

    /* Stepper */
    .stepper {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 40px;
        padding: 0 10px;
    }
    .step-item { text-align: center; font-size: 12px; color: #3498db; }
    .step-item .circle {
        width: 35px; height: 35px;
        border-radius: 50%;
        border: 2px solid #57cc99;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto 5px;
        background: white; color: #57cc99;
        font-weight: bold;
    }
    .step-item .circle.active { background: #57cc99; color: white; }
    .step-item .circle.checked { background: #57cc99; color: white; font-size: 18px; }
    .line { flex: 1; height: 2px; background: #57cc99; margin-bottom: 25px; }

    /* Imagem 1: Cards de Saldo e Valores */
    .balance-card {
        background: var(--primary-blue);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
        margin-bottom: -10px;
    }
    .amount-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .input-wrapper {
        display: flex; border: 1px solid #ddd;
        border-radius: 8px; padding: 10px; margin: 10px 0;
    }
    .input-wrapper input { border: none; outline: none; width: 100%; margin-left: 10px; font-size: 16px; }

    .grid-amounts {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0;
    }
    .amount-btn {
        border: 1px solid #ddd; background: white;
        padding: 10px 5px; border-radius: 50%;
        font-size: 11px; cursor: pointer; aspect-ratio: 1;
    }
    .amount-btn.active { border-color: var(--primary-blue); color: var(--primary-blue); }

    /* Regras */
    .info-rules { margin-top: 20px; font-size: 13px; color: #555; background: #fff9f9; padding: 15px; border-radius: 8px; }
    .info-rules h4 { margin-top: 0; color: #c0392b; }
    .info-rules ul { list-style: none; padding: 0; }
    .info-rules li { margin-bottom: 8px; display: flex; align-items: flex-start; }
    .info-rules li span { 
        background: #c0392b; color: white; width: 18px; height: 18px; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 10px; margin-right: 8px; flex-shrink: 0; margin-top: 2px;
    }

    /* Imagem 2: Bancos */
    .bank-option-btn {
        width: 100%; padding: 15px; margin-bottom: 10px;
        background: white; border: 1px solid #eee;
        text-align: center; border-radius: 5px; cursor: pointer;
        font-weight: 500; transition: 0.2s;
    }
    .bank-option-btn.active { border: 2px solid var(--primary-blue); background: #f0f4ff; }

    /* Imagem 3: Detalhes */
    .info-group { margin-bottom: 15px; }
    .info-group label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
    .copy-input {
        display: flex; align-items: center; background: #fff;
        border: 1px solid #ddd; border-radius: 6px; overflow: hidden;
    }
    .copy-input input { border: none; padding: 12px; flex: 1; outline: none; font-size: 14px; background: transparent; }
    .copy-icon { background: #81ecec; border: none; padding: 12px; cursor: pointer; }

    /* Imagem 4: Upload */
    .upload-label { text-align: center; color: #999; margin-bottom: 15px; }
    .upload-box {
        border: 2px dashed #ccc; border-radius: 10px;
        padding: 40px; text-align: center; cursor: pointer;
    }
    .upload-icon { font-size: 40px; color: #ccc; }
    .simple-input {
        width: 100%; border: 1px solid #eee; border-radius: 8px;
        padding: 15px; box-sizing: border-box; background: #fafafa;
    }

    /* Bot√£o Principal */
    .btn-main {
        width: 100%; background: var(--primary-blue); color: white;
        border: none; padding: 15px; border-radius: 30px;
        font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
    }
    .btn-main:disabled { background: #ccc; cursor: not-allowed; }

    /* Sucesso */
    .success-screen { text-align: center; padding: 40px 20px; }
    .success-icon { 
        width: 80px; height: 80px; background: #57cc99; color: white;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 40px; margin: 0 auto 20px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentStep = 1;
        const amountBtns = document.querySelectorAll('.amount-btn');
        const bankBtns = document.querySelectorAll('.bank-option-btn');
        const next1 = document.getElementById('to-step-2');
        const next2 = document.getElementById('to-step-3');
        const amountInput = document.getElementById('id_amount');
        const bankInput = document.getElementById('id_selected_bank');

        // Sele√ß√£o de Valor
        amountBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                amountBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                amountInput.value = btn.dataset.value;
                document.querySelectorAll('.display-final-amount').forEach(el => el.value = btn.dataset.value + ".00");
                next1.disabled = false;
            });
        });

        // Navega√ß√£o Step 1 -> 2
        next1.addEventListener('click', () => {
            goToStep(2);
            updateStepper(2);
        });

        // Sele√ß√£o de Banco
        bankBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                bankBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                bankInput.value = btn.dataset.bankId;
                next2.disabled = false;
            });
        });

        // Navega√ß√£o Step 2 -> 3
        next2.addEventListener('click', () => {
            const bankId = bankInput.value;
            document.querySelectorAll('.bank-info-card').forEach(card => card.style.display = 'none');
            document.getElementById(`details-${bankId}`).style.display = 'block';
            goToStep(3);
            updateStepper(2); // "Pagar" ainda √© step 2 no visual
        });

        // Navega√ß√£o Step 3 -> 4
        document.getElementById('to-step-4').addEventListener('click', () => {
            goToStep(4);
            updateStepper(3);
        });

        // File Upload preview
        document.getElementById('file-upload').addEventListener('change', function() {
            document.getElementById('file-name').innerText = this.files[0] ? this.files[0].name : "";
        });

        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
            document.getElementById(`step-${step}`).style.display = 'block';
            window.scrollTo(0,0);
        }

        function updateStepper(activeStep) {
            const dots = document.querySelectorAll('.step-item .circle');
            dots.forEach((dot, idx) => {
                if (idx + 1 < activeStep) {
                    dot.classList.add('checked');
                    dot.innerHTML = "‚úì";
                } else if (idx + 1 === activeStep) {
                    dot.classList.add('active');
                }
            });
        }
    });

    function copyText(id) {
        const copyText = document.getElementById(id);
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
        alert("Copiado: " + copyText.value);
    }
</script>
{% endblock %}
